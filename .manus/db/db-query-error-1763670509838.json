{
  "query": "-- Tabela de cupons de desconto\nCREATE TABLE IF NOT EXISTS cupons (\n  id INT AUTO_INCREMENT PRIMARY KEY,\n  box_id INT NOT NULL,\n  codigo VARCHAR(50) NOT NULL UNIQUE,\n  tipo ENUM('percentual', 'valor_fixo') NOT NULL,\n  valor DECIMAL(10, 2) NOT NULL,\n  descricao TEXT,\n  limite_uso INT DEFAULT NULL,\n  usos_atuais INT DEFAULT 0,\n  data_validade DATETIME DEFAULT NULL,\n  ativo BOOLEAN DEFAULT TRUE,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n  INDEX idx_box_id (box_id),\n  INDEX idx_codigo (codigo)\n);\n\n-- Tabela de uso de cupons\nCREATE TABLE IF NOT EXISTS cupons_usados (\n  id INT AUTO_INCREMENT PRIMARY KEY,\n  cupom_id INT NOT NULL,\n  user_id INT NOT NULL,\n  assinatura_id INT NOT NULL,\n  valor_desconto DECIMAL(10, 2) NOT NULL,\n  data_uso TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  FOREIGN KEY (cupom_id) REFERENCES cupons(id) ON DELETE CASCADE,\n  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,\n  FOREIGN KEY (assinatura_id) REFERENCES assinaturas(id) ON DELETE CASCADE,\n  INDEX idx_cupom_id (cupom_id),\n  INDEX idx_user_id (user_id)\n);\n\n-- Adicionar campo de código de indicação único para cada usuário\nALTER TABLE users ADD COLUMN IF NOT EXISTS codigo_indicacao VARCHAR(20) UNIQUE DEFAULT NULL;\n\n-- Tabela de indicações\nCREATE TABLE IF NOT EXISTS indicacoes (\n  id INT AUTO_INCREMENT PRIMARY KEY,\n  indicador_id INT NOT NULL,\n  indicado_id INT NOT NULL,\n  data_indicacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  desconto_aplicado BOOLEAN DEFAULT FALSE,\n  FOREIGN KEY (indicador_id) REFERENCES users(id) ON DELETE CASCADE,\n  FOREIGN KEY (indicado_id) REFERENCES users(id) ON DELETE CASCADE,\n  INDEX idx_indicador (indicador_id),\n  INDEX idx_indicado (indicado_id)\n);",
  "command": "mysql --batch --raw --column-names --default-character-set=utf8mb4 --host gateway02.us-east-1.prod.aws.tidbcloud.com --port 4000 --user njLUTjzwczDK38t.a52c1e22817e --database WZEKsstKXPtdSNXaJtxfch --execute -- Tabela de cupons de desconto\nCREATE TABLE IF NOT EXISTS cupons (\n  id INT AUTO_INCREMENT PRIMARY KEY,\n  box_id INT NOT NULL,\n  codigo VARCHAR(50) NOT NULL UNIQUE,\n  tipo ENUM('percentual', 'valor_fixo') NOT NULL,\n  valor DECIMAL(10, 2) NOT NULL,\n  descricao TEXT,\n  limite_uso INT DEFAULT NULL,\n  usos_atuais INT DEFAULT 0,\n  data_validade DATETIME DEFAULT NULL,\n  ativo BOOLEAN DEFAULT TRUE,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n  INDEX idx_box_id (box_id),\n  INDEX idx_codigo (codigo)\n);\n\n-- Tabela de uso de cupons\nCREATE TABLE IF NOT EXISTS cupons_usados (\n  id INT AUTO_INCREMENT PRIMARY KEY,\n  cupom_id INT NOT NULL,\n  user_id INT NOT NULL,\n  assinatura_id INT NOT NULL,\n  valor_desconto DECIMAL(10, 2) NOT NULL,\n  data_uso TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  FOREIGN KEY (cupom_id) REFERENCES cupons(id) ON DELETE CASCADE,\n  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,\n  FOREIGN KEY (assinatura_id) REFERENCES assinaturas(id) ON DELETE CASCADE,\n  INDEX idx_cupom_id (cupom_id),\n  INDEX idx_user_id (user_id)\n);\n\n-- Adicionar campo de código de indicação único para cada usuário\nALTER TABLE users ADD COLUMN IF NOT EXISTS codigo_indicacao VARCHAR(20) UNIQUE DEFAULT NULL;\n\n-- Tabela de indicações\nCREATE TABLE IF NOT EXISTS indicacoes (\n  id INT AUTO_INCREMENT PRIMARY KEY,\n  indicador_id INT NOT NULL,\n  indicado_id INT NOT NULL,\n  data_indicacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  desconto_aplicado BOOLEAN DEFAULT FALSE,\n  FOREIGN KEY (indicador_id) REFERENCES users(id) ON DELETE CASCADE,\n  FOREIGN KEY (indicado_id) REFERENCES users(id) ON DELETE CASCADE,\n  INDEX idx_indicador (indicador_id),\n  INDEX idx_indicado (indicado_id)\n);",
  "returncode": 1,
  "logs": [
    "ERROR 8200 (HY000) at line 35: unsupported add column 'codigo_indicacao' constraint UNIQUE KEY when altering 'WZEKsstKXPtdSNXaJtxfch.users'"
  ]
}